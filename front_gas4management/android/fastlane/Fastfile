default_platform(:android)

# í—¬í¼: __dir__ = android/fastlane (Fastfile ìœ„ì¹˜)
def gas_aab_path
  File.expand_path('../app/build/outputs/bundle/release/app-release.aab', __dir__)
end

def gas_json_key
  ENV['GOOGLE_APPLICATION_CREDENTIALS'] || File.expand_path('play2.json', __dir__)
end

def gas_release_paths
  [
    File.expand_path('../../scripts/release.txt', __dir__),
    File.expand_path('../../release.txt', __dir__),
    File.expand_path('../release.txt', __dir__),
    File.join(File.dirname(__dir__), 'release.txt'),
  ]
end

def gas_read_whats_new
  whats_new = nil
  gas_release_paths.each do |path|
    next unless File.exist?(path)
    begin
      whats_new = File.read(path, encoding: 'UTF-8').strip
      UI.success("âœ… ë³€ê²½ ë‚´ìš© íŒŒì¼ ì°¾ìŒ: #{path}")
      break
    rescue => e
      UI.message("âš ï¸  íŒŒì¼ ì½ê¸° ì‹¤íŒ¨: #{e.message}")
    end
  end
  if whats_new.nil? || whats_new.empty?
    whats_new = "Release - #{Time.now.strftime('%Y-%m-%d %H:%M')}"
    UI.important("âš ï¸  release.txtë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ ê¸°ë³¸ ë©”ì‹œì§€ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.")
  elsif whats_new.length > 500
    whats_new = whats_new[0..496] + "..."
    UI.important("âš ï¸  ë³€ê²½ ë‚´ìš©ì´ ë„ˆë¬´ ê¸¸ì–´ 500ìë¡œ ì œí•œí–ˆìŠµë‹ˆë‹¤.")
  end
  whats_new
end

platform :android do
  desc "Build AAB and upload to Google Play Open Testing"
  lane :open_beta do |options|
    package = options[:package_name] || 'com.joainfo.gas_management'
    aab_path = options[:aab_path] || gas_aab_path
    json_key = options[:json_key_file] || gas_json_key
    track_name = options[:track] || 'beta'

    UI.user_error!("Google Play service account json key is required. Set GOOGLE_APPLICATION_CREDENTIALS or pass :json_key_file") if json_key.nil? || json_key.to_s.empty?

    UI.important("ğŸš€ ì˜¤í”ˆ ë² íƒ€ ë°°í¬ ì‹œì‘")
    UI.message("ğŸ“¦ íŒ¨í‚¤ì§€ëª…: #{package}")
    UI.message("ğŸ¯ íŠ¸ë™: #{track_name}")

    UI.message("ğŸ“± Gradle AAB ë¹Œë“œ ì¤‘...")
    gradle(task: 'bundleRelease')

    unless File.exist?(aab_path)
      UI.user_error!("âŒ AAB íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: #{aab_path}")
    end
    UI.success("âœ… AAB ë¹Œë“œ ì™„ë£Œ: #{aab_path}")

    whats_new = gas_read_whats_new
    UI.message("ğŸ“‹ ë³€ê²½ ë‚´ìš©:")
    UI.message(whats_new.split("\n").first(5).join("\n"))

    UI.message("ğŸ“¤ Google Playì— ì—…ë¡œë“œ ì¤‘...")
    supply(
      json_key: json_key,
      package_name: package,
      aab: aab_path,
      track: track_name,
      skip_upload_apk: true,
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      skip_upload_changelogs: true,
      release_status: 'completed',
      changes_not_sent_for_review: true
    )
    UI.success("âœ… ì˜¤í”ˆ ë² íƒ€ ë°°í¬ ì™„ë£Œ!")
  end

  desc "Build AAB and upload to Google Play Production"
  lane :production do |options|
    package = options[:package_name] || 'com.joainfo.gas_management'
    aab_path = options[:aab_path] || gas_aab_path
    json_key = options[:json_key_file] || gas_json_key
    track_name = 'production'

    UI.user_error!("Google Play service account json key is required. Set GOOGLE_APPLICATION_CREDENTIALS or pass :json_key_file") if json_key.nil? || json_key.to_s.empty?

    UI.important("ğŸš€ í”„ë¡œë•ì…˜ ë°°í¬ ì‹œì‘")
    UI.message("ğŸ“¦ íŒ¨í‚¤ì§€ëª…: #{package}")
    UI.message("ğŸ¯ íŠ¸ë™: #{track_name}")

    UI.message("ğŸ“± Gradle AAB ë¹Œë“œ ì¤‘...")
    gradle(task: 'bundleRelease')

    unless File.exist?(aab_path)
      UI.user_error!("âŒ AAB íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: #{aab_path}")
    end
    UI.success("âœ… AAB ë¹Œë“œ ì™„ë£Œ: #{aab_path}")

    whats_new = gas_read_whats_new
    UI.message("ğŸ“‹ ë³€ê²½ ë‚´ìš©:")
    UI.message(whats_new.split("\n").first(5).join("\n"))

    UI.message("ğŸ“¤ Google Play í”„ë¡œë•ì…˜ íŠ¸ë™ì— ì—…ë¡œë“œ ì¤‘...")
    supply(
      json_key: json_key,
      package_name: package,
      aab: aab_path,
      track: track_name,
      skip_upload_apk: true,
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      skip_upload_changelogs: false,
      release_status: 'completed',
      changes_not_sent_for_review: false
    )
    UI.success("âœ… í”„ë¡œë•ì…˜ ë°°í¬ ì™„ë£Œ!")
  end

  desc "Build AAB and upload to Google Play Production as DRAFT (no rollout)"
  lane :prod_pre_release do |options|
    package = options[:package_name] || 'com.joainfo.gas_management'
    aab_path = options[:aab_path] || gas_aab_path
    json_key = options[:json_key_file] || gas_json_key
    track_name = 'production'

    UI.user_error!("Google Play service account json key is required. Set GOOGLE_APPLICATION_CREDENTIALS or pass :json_key_file") if json_key.nil? || json_key.to_s.empty?

    UI.important("ğŸš€ í”„ë¡œë•ì…˜ DRAFT ë°°í¬ ì‹œì‘")
    UI.message("ğŸ“¦ íŒ¨í‚¤ì§€ëª…: #{package}")
    UI.message("ğŸ¯ íŠ¸ë™: #{track_name}")

    UI.message("ğŸ“± Gradle AAB ë¹Œë“œ ì¤‘...")
    gradle(task: 'bundleRelease')

    unless File.exist?(aab_path)
      UI.user_error!("âŒ AAB íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: #{aab_path}")
    end
    UI.success("âœ… AAB ë¹Œë“œ ì™„ë£Œ: #{aab_path}")

    UI.message("ğŸ“¤ Google Play í”„ë¡œë•ì…˜ íŠ¸ë™(DRAFT) ì—…ë¡œë“œ ì¤‘...")
    supply(
      json_key: json_key,
      package_name: package,
      aab: aab_path,
      track: track_name,
      skip_upload_apk: true,
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      skip_upload_changelogs: true,
      release_status: 'draft',
      changes_not_sent_for_review: true
    )
    UI.success("âœ… í”„ë¡œë•ì…˜ DRAFT ì—…ë¡œë“œ ì™„ë£Œ! (ì•„ì§ ì‚¬ìš©ìì—ê²ŒëŠ” ë¯¸ë…¸ì¶œ)")
  end

  desc "Build AAB and upload to Google Play Internal Testing"
  lane :internal_testing do |options|
    options[:track] = 'internal'
    open_beta(options)
  end

  desc "Build AAB and upload to Google Play Closed Testing"
  lane :closed_testing do |options|
    options[:track] = 'alpha'
    open_beta(options)
  end

  desc "Upload existing AAB to Production (Skip Build)"
  lane :production_deploy_only do |options|
    package = options[:package_name] || 'com.joainfo.gas_management'
    aab_path = options[:aab_path] || gas_aab_path
    json_key = options[:json_key_file] || gas_json_key
    track_name = 'production'

    UI.user_error!("Google Play service account json key is required. Set GOOGLE_APPLICATION_CREDENTIALS or pass :json_key_file") if json_key.nil? || json_key.to_s.empty?

    UI.important("ğŸš€ í”„ë¡œë•ì…˜ ë°°í¬ (ë¹Œë“œ ê±´ë„ˆëœ€) ì‹œì‘")

    whats_new = gas_read_whats_new
    UI.message("ğŸ“‹ ë³€ê²½ ë‚´ìš©: #{whats_new.split("\n").first(3).join(' ')}")

    unless File.exist?(aab_path)
      UI.user_error!("âŒ AAB íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: #{aab_path}")
    end

    supply(
      json_key: json_key,
      package_name: package,
      aab: aab_path,
      track: track_name,
      skip_upload_apk: true,
      skip_upload_metadata: true,
      skip_upload_images: true,
      skip_upload_screenshots: true,
      skip_upload_changelogs: false,
      release_status: 'completed',
      changes_not_sent_for_review: false
    )
    UI.success("âœ… í”„ë¡œë•ì…˜ ë°°í¬ ì™„ë£Œ")
  end

  desc "Show current version and changelog"
  lane :version_info do
    build_gradle_path = File.expand_path('../app/build.gradle', __dir__)
    if File.exist?(build_gradle_path)
      content = File.read(build_gradle_path)
      version_code = content.match(/versionCode\s+(\d+)/)&.[](1)
      version_name = content.match(/versionName\s+"([^"]+)"/)&.[](1)
      UI.message("ğŸ“± í˜„ì¬ ë²„ì „ ì •ë³´:")
      UI.message("   Version Code: #{version_code}")
      UI.message("   Version Name: #{version_name}")
    end

    gas_release_paths.each do |path|
      next unless File.exist?(path)
      UI.message("\nğŸ“ ë³€ê²½ ë‚´ìš© (#{path}):")
      UI.message(File.read(path, encoding: 'UTF-8'))
      break
    end
  end

  # Firebase App Distribution (ê¸°ì¡´ beta lane)
  lane :beta do
    gradle(task: 'assembleRelease')
    apk_path = File.expand_path('../app/build/outputs/apk/release/app-release.apk', __dir__)

    unless File.exist?(apk_path)
      UI.user_error!("âŒ APK íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: #{apk_path}")
    end

    firebase_app_distribution(
      app: "1:80656391423:android:ebac598125c05cb6d300ca",
      groups: "aaaaa",
      release_notes: "ìƒì„¸ ì¤‘ë³µ ë¡œë”© ì œê±°/ê°œì„ .",
      apk_path: apk_path
    )
    UI.success("âœ… Firebase App Distribution ì—…ë¡œë“œ ì™„ë£Œ")
  end
end
